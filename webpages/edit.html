<!DOCTYPE html>
<html lang="en">
<head>
<title>Code With Friends</title>
<style type="text/css" media="screen">
    .myeditor { 
        min-height: 250px; 
        min-width: 450px;
        max-width: 100%;
        max-height: 100%;
    }

    #executedCode {
        overflow: auto;
        height:250px;
    }

    #infobox {
        height: 250px;
        border: 2px solid blue;
    }

    #inputcodebox {
        border: 2px solid green;
    }

    #formresetsession {
        text-align: center;
    }

    #formnewsession {
        text-align: center;
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://ace.ajax.org/build/src/ace.js" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</head>
<body>

<div style="width: 95%;" class="container-fluid">
    <div class="row">
        <h1 class="col-md-12"> Code With Friends </h1>
    </div>
    <div id="infobox" class="row">
        <div class="col-md-10" id="executedCode">
            <pre class="bg-primary">Welcome to Code With Friends!</pre>
        </div>
        <div class="col-md-2" style="border: 2px solid red;">
            <p>Current Session: <span id="sessionName"></span></p>
            <form id="formresetsession" action="/resetsession/" method="POST">
                <input id="resetsessionbutton" type="submit" class="btn btn-danger" value="Reset session" disabled />
            </form>
        </div>
        <div class="col-md-2" style="border: 2px solid red;">
            <form id="formnewsession" action="/newsession/" method="POST">
                <input type="text" name="newsessionname" id="newSessionName" />
                <input id="newsessionbutton" type="submit" class="btn btn-primary" value="Create new session" />
            </form>
        </div>
    </div>

    <div id="inputcodebox" class="row">
        <div class="col-md-5">
            <div class="myeditor" id="editor1">def foo(items):
    x = "All this is syntax highlighted"
    return x</div>
            <form id="formsubmitcode" action="/executecode/submit" method="POST">
                <input id="mycodebutton" type="submit" class="btn btn-default" value="Code" disabled />
            </form>
        </div>

        <div class="col-md-5">
            <div class="myeditor" id="editor2">def bar(items):
    y = "This too!"
    return y</div>
            <form action="/executecode/submit" method="POST">
                <input type="submit" class="btn btn-default" value="Code" disabled />
            </form>
        </div>
        <div class="col-md-2" style="border: 2px solid red;">
            <p> Swap Code Box Here </p>
        </div>
    </div>
</div>
<script>
    var editors = []
    var numEditors = 2;
    for (i = 0; i < numEditors; i++) {
        editors[i] = ace.edit("editor" + (i+1));
        editors[i].setTheme("ace/theme/monokai");
        editors[i].setFontSize(12);
        editors[i].getSession().setMode("ace/mode/python");
    }

    // React to reset the session.
    $('#formresetsession').submit(function() {
        $theForm = $(this);
        $.ajax({
            type: $theForm.attr('method'),
            url: $theForm.attr('action'),
            data: $theForm.serialize(), // TODO Fill this with unique session ID maybe?
            success: function(data) {
                console.log('Yay! Reset session.');
            }
        });
        return false;
    });

    // React to creating new session.
    $('#formnewsession').submit(function() {
        $theForm = $(this);
        document.getElementById("resetsessionbutton").disabled = false;
		$('#sessionName').text($('#newSessionName').val());
        $.ajax({
            type: $theForm.attr('method'),
            url: $theForm.attr('action'),
			data: {newsessionname:$('#newSessionName').val()},
            success: function(data) {
                console.log('Yay! New session.');
            }
        });
        return false;
    });

    // React to submitting new code.
    $('#formsubmitcode').submit(function() {
        $theForm = $(this);
        var editorId = $(this).prev().attr('id');
        var editorNumber = editorId[editorId.length - 1];
        var editor = editors[editorNumber - 1];
        console.log(editor.getSession().getValue());
        // send xhr request
        $.ajax({
            type: $theForm.attr('method'),
            url: $theForm.attr('action'),
            data: {codeToExecute : editor.getSession().getValue()},
            success: function(data) {
                console.log('Yay! Form sent.');
            }
        });
        return false;
    });

    var pollForActiveSessionDelay = 1000;
    (function pollForActiveSession() {
        setTimeout(function() {
            if ($("#sessionName").text() == "") {
				setTimeout(pollForActiveSession, 1000);
                return;
			}
            $.ajax({
                url: "/readsessionactive/",
                type: "GET",
                success: function(data) {
                    console.log("got data: " + data);
                    mycodebutton = document.getElementById("mycodebutton");
                    newsessionbutton = document.getElementById("newsessionbutton");
                    if (data == "ACTIVE") {
                        $("#newsessionbutton").removeClass("btn-primary");
                        $("#newsessionbutton").addClass("btn-danger");
                        newsessionbutton.value = "Restart session";
                        newsessionbutton.disabled = false;
                        mycodebutton.disabled = false;
                        pollForActiveSessionDelay = 2500;
                    } else if (data == "DEAD") {
                        $("#newsessionbutton").removeClass("btn-danger");
                        $("#newsessionbutton").addClass("btn-primary");
                        newsessionbutton.value = "Create new session";
                        newsessionbutton.disabled = false;
                        mycodebutton.disabled = true;
                    }
                },
                complete: pollForActiveSession,
                timeout: 1000
            })
        }, pollForActiveSessionDelay);

    })();

    var seqNum = 0;
    var pollForExecutedCodeDelay = 1000;
    var messageReceived = true;
    (function pollForExecutedCode() {
        setTimeout(function() {
            if ($("#sessionName").text() == "") {
				setTimeout(pollForExecutedCode, 1000);
                return;
			}
            $.ajax({
                url: "/readexecutedcode/" + seqNum,
                type: "GET",
                success: function(data) {
                    console.log("For seqNum: " + seqNum + ", got data: " + data);
                    ta = document.getElementById("executedCode");
                    console.log(data.substr(0, 4));
                    messageReceived = true;
                    if (data.substr(0, 4) == "INP:") {
                        seqNum += 1;
                        $("#executedCode").append("<pre class='bg-info'>" + data.substr(4) + "\<\/pre>");
                    } else if (data.substr(0, 4) == "OUT:") {
                        seqNum += 1;
                        $("#executedCode").append("<pre class='bg-success'>" + data.substr(4) + "\<\/pre>");
                    } else if (data.substr(0, 4) == "ERR:") {
                        seqNum += 1;
                        $("#executedCode").append("<pre class='bg-danger'>" + data.substr(4) + "\<\/pre>");
                    } else if (data.substr(0, 4) == "ZERO") {
                        seqNum = 0;
                        $("#executedCode").append("<pre class='bg-warning'> Session Restarting. \<\/pre>");
                    } else {
                        messageReceived = false;
                        console.log("Throttling polling for executed code");
                        pollForExecutedCodeDelay = 2500;
                    }
                    
                    if (messageReceived) {
                        $("#executedCode").animate({
                            scrollTop:$("#executedCode")[0].scrollHeight - $("#executedCode").height()
                        })
                        pollForExecutedCodeDelay = 1000;
                    }
                },
                complete: pollForExecutedCode,
                timeout: 1000
            })
        }, pollForExecutedCodeDelay);
    })();

</script>


</body>
</html>






